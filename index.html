<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Trifusion Technologies ‚Äî Cat√°logo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:system-ui;background:#0b0f19;color:#e6ecff}
header{background:#000;padding:16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 15px rgba(0,0,0,0.5);position:sticky;top:0;z-index:100}
.catalogo{max-width:1100px;margin:20px auto;padding:0 16px}
.categoria{margin:24px 0 10px;padding:12px;background:rgba(0,57,77,0.8);font-weight:800;text-transform:uppercase;border-left:4px solid #00c2ff;border-radius:0 8px 8px 0;box-shadow:0 2px 10px rgba(0,194,255,0.15)}
.producto{background:rgba(16,22,36,0.85);border:1px solid rgba(31,41,64,0.7);border-radius:12px;padding:18px;margin-bottom:15px;display:flex;flex-direction:column;gap:12px;transition:all 0.3s ease;position:relative;overflow:hidden}
.producto::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#00c2ff,#7b3fe4,#ff4b6a);opacity:0.7}
.producto:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.4);border-color:rgba(0,194,255,0.4)}
@media (min-width:768px){
.producto{flex-direction:row;align-items:center}
.descripcion{flex:1}
.producto-img-container{width:180px;height:180px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
}
.descripcion{color:#4da6ff;font-weight:700;font-size:1.15rem}
.precio{color:#ff4b6a;font-weight:800;font-size:1.4rem;white-space:nowrap}
.btn{border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.95rem;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.4)}
.admin-btn{background:linear-gradient(90deg,#ffb703,#ff9a00);color:#000}
.img-btn{background:linear-gradient(90deg,#00c2ff,#0088ff);color:white}
.modal,.login{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity 0.3s ease}
.modal.active,.login.active{display:flex;opacity:1}
.modal img{max-width:90%;max-height:85vh;border-radius:16px;box-shadow:0 15px 50px rgba(0,0,0,0.6);border:2px solid rgba(0,194,255,0.5)}
.login-box{background:rgba(16,22,36,0.95);padding:30px;border-radius:20px;width:90%;max-width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid rgba(100,150,255,0.3);position:relative}
.login-box h3{margin-top:0;color:#00c2ff;text-align:center;font-weight:800;font-size:1.5rem;margin-bottom:20px}
.login-box input{width:100%;padding:14px;margin-top:12px;border-radius:12px;border:1px solid rgba(100,120,180,0.6);background:rgba(10,15,30,0.8);color:white;font-size:1.05rem}
.login-box input:focus{outline:none;border-color:#00c2ff;box-shadow:0 0 0 3px rgba(0,194,255,0.2)}
.status{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:12px;font-weight:700;z-index:2000;box-shadow:0 5px 20px rgba(0,0,0,0.4);animation:slideIn 0.3s, fadeOut 0.5s 2.5s forwards}
@keyframes slideIn{from{transform:translateX(150%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fadeOut{to{opacity:0;transform:translateX(150%)}}
.success{background:linear-gradient(90deg,#00c853,#009629);color:white;border:1px solid #00c853}
.error{background:linear-gradient(90deg,#ff5252,#c53030);color:white;border:1px solid #ff5252}
img.product-image{max-width:100%;max-height:180px;object-fit:contain;border-radius:12px;margin:10px auto;background:rgba(2,6,23,0.8);border:1px solid rgba(31,41,64,0.7);display:block;transition:transform 0.3s ease;cursor:pointer}
img.product-image:hover{transform:scale(1.03)}
.admin-section{background:rgba(30,25,50,0.85);padding:16px;border-radius:12px;margin-top:12px;border:1px solid rgba(100,80,180,0.6);box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.admin-section h4{color:#ffb703;margin-bottom:10px;font-size:1.1rem;display:flex;align-items:center;gap:8px}
.admin-input{width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(100,120,180,0.6);background:rgba(10,15,30,0.8);color:white;margin:8px 0;font-family:inherit;font-size:0.95rem}
.admin-input:focus{outline:none;border-color:#00c2ff;box-shadow:0 0 0 3px rgba(0,194,255,0.2)}
.admin-actions{display:flex;gap:10px;margin-top:12px}
.btn-save{flex:1;background:linear-gradient(90deg,#00c853,#009629);color:white}
.btn-delete{flex:1;background:linear-gradient(90deg,#ff4b6a,#c53030);color:white}
footer{text-align:center;padding:25px;margin-top:20px;color:rgba(230,236,255,0.6);font-size:0.9rem;border-top:1px solid rgba(31,41,64,0.7);background:rgba(10,15,25,0.7)}
.close-modal{position:absolute;top:15px;right:15px;width:40px;height:40px;border-radius:50%;background:rgba(30,30,40,0.8);border:2px solid #ff4b6a;color:white;font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;z-index:2001}
.close-modal:hover{background:#ff4b6a;transform:rotate(90deg)}
</style>
</head>
<body>
<header>
<h2 style="margin:0;font-weight:800;background:linear-gradient(90deg,#00c2ff,#7b3fe4,#ff4b6a);-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:-0.5px">Trifusion Technologies</h2>
<button id="adminBtn" class="btn admin-btn">üîê ADMIN</button>
</header>
<div id="catalogo" class="catalogo"></div>
<div id="status"></div>

<!-- MODAL DE IMAGEN -->
<div id="imgModal" class="modal">
<div style="position:relative;max-width:90%;max-height:90vh">
<button class="close-modal">&times;</button>
<img id="imgView" style="max-width:100%;max-height:85vh;border-radius:16px;box-shadow:0 15px 50px rgba(0,0,0,0.6);border:2px solid rgba(0,194,255,0.5)">
</div>
</div>

<!-- MODAL DE LOGIN -->
<div id="login" class="login">
<div class="login-box">
<h3>üîê Acceso de Administrador</h3>
<input id="email" type="email" placeholder="Correo electr√≥nico" autocomplete="email">
<input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password">
<button class="btn admin-btn" style="margin-top:18px;width:100%;padding:14px;font-size:1.15rem" onclick="handleLogin()">Iniciar Sesi√≥n</button>
<p style="margin-top:20px;font-size:0.85rem;color:#888;text-align:center;border-top:1px solid rgba(100,120,180,0.3);padding-top:15px">
‚ö†Ô∏è Solo personal autorizado<br>
üîí Tus credenciales est√°n protegidas con Firebase Authentication
</p>
</div>
</div>

<footer>
<p>Trifusion Technologies ¬© 2026 - Todos los derechos reservados</p>
<p style="margin-top:8px;font-size:0.85rem;opacity:0.7">Cat√°logo actualizado en tiempo real desde Google Sheets</p>
</footer>

<!-- LIBRER√çAS CORREGIDAS (SIN ESPACIOS EXTRA) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// üîë CONFIGURACI√ìN DE FIREBASE (CORREGIDA Y COMPLETA)
const firebaseConfig = {
    apiKey: "AIzaSyDlOJqBgd-8KqUT-Y94lsma5W8T79PsPjM",
    authDomain: "trifusion-cotizador.firebaseapp.com",
    projectId: "trifusion-cotizador",
    storageBucket: "trifusion-cotizador.firebasestorage.app",
    messagingSenderId: "407374211882",
    appId: "1:407374211882:web:b692792ccc39c8d48f4c53"
};

// Inicializar Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();

// CONFIGURACI√ìN DEL CAT√ÅLOGO
const SHEET_ID = "1EtOwxNRGq0WFgGaRXtJgibUqzxIgcAUeRkJlr1wPsLc";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`; // ‚úÖ CORREGIDO: sin espacios
const cont = document.getElementById("catalogo");
const statusDiv = document.getElementById("status");
const loginModal = document.getElementById("login");
const imageModal = document.getElementById("imgModal");
const modalImage = document.getElementById("imgView");
const closeModalBtn = document.querySelector(".close-modal");

let isAdmin = false;
let productImages = {};

// ‚úÖ CORREGIDO: Funci√≥n para convertir URLs de Google Drive (SIN ESPACIOS EN LAS URLS)
function convertDriveUrl(url) {
    if (!url) return url;
    
    // Convertir formato /file/d/ID/view
    if (url.includes('drive.google.com') && url.includes('/file/d/')) {
        const match = url.match(/\/d\/([^\/?]+)/);
        if (match && match[1]) {
            return `https://drive.google.com/uc?export=view&id=${match[1]}`; // ‚úÖ SIN ESPACIOS
        }
    }
    
    // Convertir formato /open?id=ID
    if (url.includes('drive.google.com') && url.includes('open?id=')) {
        const match = url.match(/open\?id=([^&]+)/);
        if (match && match[1]) {
            return `https://drive.google.com/uc?export=view&id=${match[1]}`; // ‚úÖ SIN ESPACIOS
        }
    }
    
    return url;
}

// MOSTRAR MENSAJES DE ESTADO
function showStatus(message, isSuccess) {
    statusDiv.textContent = message;
    statusDiv.className = isSuccess ? 'status success' : 'status error';
    setTimeout(() => {
        if (statusDiv.className.includes('success') || statusDiv.className.includes('error')) {
            statusDiv.className = '';
        }
    }, 3000);
}

// MANEJAR LOGIN
function handleLogin() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    
    if (!email || !password) {
        return showStatus("‚ö†Ô∏è Completa ambos campos", false);
    }
    
    auth.signInWithEmailAndPassword(email, password)
        .then(() => {
            loginModal.classList.remove("active");
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";
            showStatus("‚úÖ Sesi√≥n iniciada correctamente", true);
        })
        .catch(e => {
            console.error("Error de autenticaci√≥n:", e);
            showStatus("‚ùå " + (e.message.includes("password") ? "Contrase√±a incorrecta" : e.message.includes("user-not-found") ? "Usuario no encontrado" : "Error de autenticaci√≥n")), false);
        });
}

// CERRAR MODALES
closeModalBtn.onclick = () => imageModal.classList.remove("active");
imageModal.onclick = (e) => {
    if (e.target === imageModal) imageModal.classList.remove("active");
};
loginModal.onclick = (e) => {
    if (e.target === loginModal) loginModal.classList.remove("active");
};

// OBSERVADOR DE ESTADO DE AUTENTICACI√ìN
auth.onAuthStateChanged(user => {
    isAdmin = !!user;
    document.getElementById("adminBtn").textContent = isAdmin ? "üëã SALIR" : "üîê ADMIN";
    
    if (isAdmin) {
        document.getElementById("adminBtn").onclick = () => {
            auth.signOut().then(() => {
                showStatus("‚úÖ Sesi√≥n cerrada correctamente", true);
            });
        };
        loginModal.classList.remove("active");
    } else {
        document.getElementById("adminBtn").onclick = () => {
            loginModal.classList.add("active");
            document.getElementById("email").focus();
        };
    }
    
    cargarCatalogo();
});

// FUNCIONES AUXILIARES
const limpiar = t => t.replace(/[\u{1F300}-\u{1FAFF}]/gu, "").trim();
const generarId = t => limpiar(t).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
const formatearPrecio = n => "$" + Number(n).toLocaleString("es-DO");

// CARGAR IM√ÅGENES DE FIRESTORE
async function cargarImagenes() {
    try {
        const snapshot = await db.collection("products").get();
        productImages = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.imageUrl) {
                // ‚úÖ Convertir URL autom√°ticamente si es de Drive
                productImages[doc.id] = convertDriveUrl(data.imageUrl);
            }
        });
    } catch (e) {
        console.error("Error cargando im√°genes:", e);
        showStatus("‚ö†Ô∏è Error cargando im√°genes: " + e.message, false);
    }
}

// VER IMAGEN EN MODAL
function verImagen(src) {
    modalImage.src = src;
    imageModal.classList.add("active");
}

// CARGAR CAT√ÅLOGO COMPLETO
async function cargarCatalogo() {
    try {
        await cargarImagenes();
        
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error("No se pudo cargar la hoja de c√°lculo");
        
        const csv = await res.text();
        cont.innerHTML = '<div style="text-align:center;padding:40px;color:#00c2ff;font-size:1.2rem">Cargando productos...<br><span style="font-size:0.9rem;opacity:0.7;display:block;margin-top:10px">Conectando con Google Sheets</span></div>';
        
        Papa.parse(csv, {
            skipEmptyLines: true,
            complete: (results) => {
                cont.innerHTML = "";
                
                results.data.forEach(row => {
                    const A = (row[0] || "").trim();
                    const C = (row[2] || "").trim(); // Nombre/Modelo
                    const D = (row[3] || "").trim(); // Precio
                    
                    // Detectar categor√≠as (fila con un solo valor, sin n√∫meros, texto corto)
                    if (row.filter(c => (c || "").trim()).length === 1 && !/\d/.test(row.join("")) && row.join("").length < 20 && !row.join("").toUpperCase().includes("TRANSITO")) {
                        const cat = document.createElement("div");
                        cat.className = "categoria";
                        cat.textContent = limpiar(row.join(""));
                        cont.appendChild(cat);
                        return;
                    }
                    
                    // Saltar productos en TR√ÅNSITO o filas inv√°lidas
                    if (!C || !D || D.toUpperCase().includes("TRANSITO")) return;
                    const num = D.replace(/\D/g, "");
                    if (!num || num === "0") return;
                    
                    // Generar nombre completo y ID √∫nico
                    const nombreLimpio = limpiar(A ? A + " " : "") + C;
                    const id = generarId(nombreLimpio);
                    const imgUrl = productImages[id] || "";
                    
                    // Crear elemento de producto
                    const prod = document.createElement("div");
                    prod.className = "producto";
                    prod.dataset.productId = id;
                    
                    // Construir HTML del producto
                    let productHTML = `
                        <div class="producto-content">
                            <div class="descripcion">${nombreLimpio}</div>
                            ${imgUrl ? `
                            <div class="producto-img-container">
                                <img src="${imgUrl}" alt="${nombreLimpio}" class="product-image" onclick="verImagen('${imgUrl.replace(/'/g, "\\'")}')">
                            </div>
                            ` : ''}
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:12px;min-width:180px">
                            <div class="precio">${formatearPrecio(num)}</div>
                    `;
                    
                    // Secci√≥n de administraci√≥n (solo visible para admin)
                    if (isAdmin) {
                        productHTML += `
                            <div class="admin-section">
                                <h4>üì∏ Imagen del Producto</h4>
                                <input type="text" class="admin-input image-input" placeholder="Pega URL de imagen (Drive, Imgur, etc.)" value="${imgUrl}">
                                <div class="admin-actions">
                                    <button class="btn btn-save save-btn" data-id="${id}">üíæ Guardar</button>
                                    ${imgUrl ? `<button class="btn btn-delete del-btn" data-id="${id}">üóëÔ∏è Eliminar</button>` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    productHTML += `</div>`;
                    prod.innerHTML = productHTML;
                    cont.appendChild(prod);
                    
                    // Configurar eventos para admin
                    if (isAdmin) {
                        const saveBtn = prod.querySelector(".save-btn");
                        const delBtn = prod.querySelector(".del-btn");
                        const urlInput = prod.querySelector(".image-input");
                        
                        if (saveBtn) {
                            saveBtn.onclick = async () => {
                                let url = urlInput.value.trim();
                                if (!url) return showStatus("‚ö†Ô∏è Ingresa una URL v√°lida", false);
                                
                                // ‚úÖ Convertir autom√°ticamente si es Google Drive
                                url = convertDriveUrl(url);
                                
                                // Validar que sea una URL de imagen
                                if (!url.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i) && !url.includes('drive.google.com') && !url.includes('uc?export')) {
                                    if (!confirm("‚ö†Ô∏è La URL no parece ser una imagen v√°lida. ¬øDeseas guardarla igual?")) return;
                                }
                                
                                try {
                                    await db.collection("products").doc(id).set({
                                        imageUrl: url,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }, { merge: true });
                                    
                                    showStatus(`‚úÖ Imagen guardada para "${nombreLimpio}"`, true);
                                    cargarCatalogo();
                                } catch (e) {
                                    console.error("Error guardando imagen:", e);
                                    showStatus("‚ùå Error: " + (e.message.includes("permission") ? "Permisos insuficientes" : e.message), false);
                                }
                            };
                        }
                        
                        if (delBtn) {
                            delBtn.onclick = async () => {
                                if (!confirm(`¬øEliminar imagen de "${nombreLimpio}"?`)) return;
                                
                                try {
                                    await db.collection("products").doc(id).update({
                                        imageUrl: firebase.firestore.FieldValue.delete(),
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    
                                    showStatus(`‚úÖ Imagen eliminada correctamente`, true);
                                    cargarCatalogo();
                                } catch (e) {
                                    console.error("Error eliminando imagen:", e);
                                    showStatus("‚ùå Error: " + e.message, false);
                                }
                            };
                        }
                    }
                });
                
                // Mensaje si no hay productos
                if (cont.innerHTML === "") {
                    cont.innerHTML = `<div style="text-align:center;padding:40px;color:#888">No se encontraron productos en el cat√°logo</div>`;
                }
            }
        });
    } catch (e) {
        console.error("Error cr√≠tico cargando cat√°logo:", e);
        cont.innerHTML = `
            <div style="background:rgba(100,0,0,0.2);border-left:4px solid #ff4b6a;padding:20px;margin:20px;border-radius:8px">
                <h3 style="color:#ff4b6a;display:flex;align-items:center;gap:10px">‚ùå Error al cargar el cat√°logo</h3>
                <p style="margin-top:10px;color:#ff8a9a">${e.message}</p>
                <p style="margin-top:15px;color:#ccc;font-size:0.9rem">
                    ‚Ä¢ Verifica tu conexi√≥n a internet<br>
                    ‚Ä¢ Confirma que la hoja de c√°lculo sea p√∫blica<br>
                    ‚Ä¢ Revisa la consola para m√°s detalles
                </p>
                <button class="btn admin-btn" style="margin-top:15px;background:#ff4b6a" onclick="cargarCatalogo()">
                    üîÑ Reintentar carga
                </button>
            </div>
        `;
    }
}

// INICIAR APLICACI√ìN
document.addEventListener("DOMContentLoaded", () => {
    // Cargar cat√°logo inicialmente
    cargarCatalogo();
    
    // Atajos de teclado para login
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            loginModal.classList.remove("active");
            imageModal.classList.remove("active");
        }
        if (e.key === "Enter" && loginModal.classList.contains("active")) {
            handleLogin();
        }
    });
});
</script>
</body>
</html>

